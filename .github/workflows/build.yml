
name: WireGuard iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Manuel tetikleme için

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. Go Ortamını Kur (Hata veren cache kısmını düzelttik)
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: false # go.sum hatasını engellemek için false veya yol belirtilmeli

      # 2. Gereklilikleri Yükle
      - name: Install Dependencies
        run: |
          brew install swiftlint # Projede varsa hata vermemesi için

      # 3. Go Bridge'i Derle (WireGuard'ın en kritik adımı)
      - name: Build WireGuard Go Bridge
        run: |
          # Go modüllerini çek ve statik kütüphaneyi oluştur
          cd Sources/WireGuardKitGo
          go mod download
          make

      # 4. Xcode Build (Sertifika hatası almamak için derleme testi modunda)
      - name: Xcode Build (Check only)
        run: |
          xcodebuild -project WireGuard.xcodeproj \
            -scheme "WireGuard-iOS" \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            clean build
            
