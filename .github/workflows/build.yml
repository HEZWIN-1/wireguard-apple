
name: WireGuard iOS Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Go Ortamını Kur (WireGuard-Go derlemesi için gerekli)
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # 2. Apple Sertifikalarını Yükle
      - name: Install Apple Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          # Sertifikayı decode et ve keychain'e ekle (Standart prosedür)
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s build.keychain

      # 3. WireGuard'ın özel scriptlerini çalıştır
      - name: Build WireGuard Go Bridge
        run: |
          # WireGuard-apple projesinde Go köprüsünü derleyen scripti tetikler
          export PATH=$PATH:$(go env GOPATH)/bin
          cd Sources/WireGuardKitGo
          make

      # 4. Xcode ile Build Et
      - name: Build for iOS
        run: |
          xcodebuild -project WireGuard.xcodeproj \
            -scheme "WireGuard-iOS" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            build
